# 史莱姆粒子发射与控制系统使用说明

## 功能概述

现在你可以通过鼠标点击将史莱姆粒子发射到指定位置，当目标位置聚集足够的粒子后，可以切换控制到新的史莱姆团块。

## ✅ 新功能：保持原史莱姆形状！

**问题已解决**：发射粒子时，原史莱姆会保持"馒头形"，不会垮成"饼形"！

### 工作原理
- 使用**过渡控制器**机制：被发射的粒子临时分配到一个低浓度的中间控制器
- 原史莱姆保持正常浓度，形状不受影响
- 粒子飞出后自动重新分配到目标控制器聚集

### 参数设置
```
ControllerTest:
├─ Maintain Original Shape: ✓ (必须勾选！)
├─ Transition Concentration: 0.1 (过渡控制器浓度，保持极低)
└─ Impulse Strength: 50 (超强发射力)
```

## 核心功能

### 1. 粒子发射
- **按住鼠标左键**：向鼠标点击的地面位置发射史莱姆粒子
- 粒子会以抛物线轨迹飞向目标位置
- **原史莱姆保持形状不变** ✨
- 发射时会显示：
  - 红色射线：发射方向
  - 黄色弧线：飞行轨迹
  - 青色球体：目标区域
  - 黄色小球：过渡控制器位置（中点）

### 2. 控制切换
- **按 Tab 键**：切换控制到目标位置的史莱姆
- 只有当目标位置有足够粒子（默认50个）时才能切换
- 切换后你的控制器会移动到新的史莱姆位置

### 3. 基础移动（保留原有功能）
- **WASD/方向键**：移动史莱姆
- **空格键**：跳跃（只在地面时有效）

## 参数说明

### Slime_PBF 核心参数
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| **Concentration** | **10** | 现在可以保持正常值！发射不会影响形状 |
| Viscosity Strength | 1-5 | 粘度，影响粒子间的粘连程度 |
| Gravity | -5 到 -10 | 重力，负值向下 |

### ControllerTest 发射设置
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| Shoot Key | Mouse0 | 发射按键（鼠标左键） |
| **Launch Speed** | **50** | 发射速度（已大幅提升） |
| **Arc Height** | **5** | 弧线高度 |
| Particles Per Batch | 20 | 每批发射的粒子数量 |
| Launch Interval | 0.05 | 发射间隔（秒） |
| Min Particles For Switch | 50 | 切换控制需要的最少粒子数 |
| Target Check Radius | 2 | 目标区域半径 |
| Switch Control Key | Tab | 切换控制按键 |
| Show Shoot Debug | true | 是否显示发射调试信息 |

### 发射力度增强
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| **Velocity Multiplier** | **15** | 速度倍增器 |
| **Use Impulse Mode** | **✓ 勾选** | 使用冲量模式 |
| **Impulse Strength** | **50** | 超强冲量力度 |

### 形状保持设置（新增！⭐）
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| **Maintain Original Shape** | **✓ 必须勾选** | 保持原史莱姆形状 |
| **Transition Concentration** | **0.1** | 过渡控制器浓度（极低） |

## 推荐配置

### 配置：保持形状 + 强力发射（推荐！）
```
Slime_PBF:
  - Concentration = 10 (正常值！)
  - Viscosity Strength = 2

ControllerTest:
  - Maintain Original Shape = ✓ ⭐ 关键！
  - Use Impulse Mode = ✓
  - Impulse Strength = 50
  - Velocity Multiplier = 15
  - Launch Speed = 50
  - Transition Concentration = 0.1
```

## 使用技巧

1. **形状保持技巧** ⭐ 新！
   - **必须勾选 `Maintain Original Shape`**
   - 原史莱姆会保持紧密的馒头形
   - 被发射的粒子通过过渡控制器飞行
   - 0.5秒后粒子自动归属目标控制器

2. **发射技巧**：
   - 持续按住鼠标左键可以连续发射
   - 在发射时可以移动鼠标改变目标位置
   - 现在可以大量发射，不用担心原史莱姆变形
   - 粒子会以超高速度（50+倍增）飞出

3. **控制切换**：
   - 随时按 Tab 键查看是否可以切换
   - 控制台会用彩色文字显示当前粒子数量
   - 切换后可以在两个史莱姆间来回切换

4. **战术运用**：
   - 将粒子发射到高处或远处探索
   - 在危险区域外创建新的史莱姆团块
   - 通过分裂同时控制多个位置
   - **现在原史莱姆形状稳定，可以持续发射！** ✨

## 调试工具

### Scene视图调试
当 `Show Shoot Debug` 开启时，会显示：
- **红色射线**：从当前位置指向目标的直线（发射方向）
- **青色线**：连接当前位置和目标的直线
- **绿色线**：目标位置的垂直标记
- **红色小球**：发射源位置（Gizmos）
- **青色球体**：目标区域范围（Gizmos）
- **黄色小球**：过渡控制器位置（中点）⭐ 新！
- **黄色弧线**：粒子飞行的轨迹预览（Gizmos）

### Console日志（彩色输出）
- 🔵 **青色**：开始发射的消息
- 🟢 **绿色**：成功发射的粒子数量和速度
- 🟡 **黄色**：创建过渡控制器 / 设置浓度 ⭐ 新！
- 🟢 **亮绿色**：延迟分配到目标控制器 ⭐ 新！
- 🟢 **亮绿**：切换控制成功
- 🟠 **橙色**：粒子数不足警告
- 🔴 **红色**：错误信息

## 技术细节

### 形状保持机制（新！）⭐

#### 过渡控制器原理
1. **开始发射**时，在发射源和目标之间创建一个**过渡控制器**
2. 过渡控制器位于中点，半径覆盖整个飞行路径
3. 过渡控制器的 `Concentration = 0.1`（极低，几乎没有吸引力）
4. 被发射的粒子先分配到过渡控制器（脱离原史莱姆）
5. 0.5秒后，粒子自动重新分配到目标控制器
6. 原史莱姆的控制器浓度保持不变（10），形状稳定

#### 三阶段流程
```
阶段1: 粒子在原史莱姆（Concentration = 10）
   ↓ 发射
阶段2: 粒子飞行中（分配到过渡控制器，Concentration = 0.1）
   ↓ 0.5秒后
阶段3: 粒子在目标位置（分配到目标控制器，Concentration = 10）
```

### 发射机制
1. 从当前位置附近获取一批粒子
2. 计算超强冲量速度（Impulse × Multiplier）
3. 给粒子施加速度
4. **立即分配到过渡控制器**（脱离原史莱姆吸引）
5. **延迟0.5秒后分配到目标控制器**（开始聚集）
6. 原史莱姆保持形状，粒子在 Slime_PBF 的物理系统中飞行

### 控制器管理
- **原控制器**：保持正常浓度（10），控制未被发射的粒子
- **过渡控制器**：极低浓度（0.1），让粒子自由飞行
- **目标控制器**：正常浓度（10），在目标位置聚集粒子
- 当粒子数量足够时，自动生成独立的史莱姆实例

### 性能优化
- 使用批量发射避免单次处理太多粒子
- 通过发射间隔控制帧率稳定性
- 空间哈希和网格查询保证粒子检测效率
- 协程延迟分配，避免每帧修改控制器

## 与现有系统的整合

这个功能完全整合到了现有的 PBF 流体模拟系统中：
- 使用 `Slime_PBF` 的公共API进行粒子操作
- 发射的粒子遵循相同的物理约束（碰撞、粘度、重力）
- 自动参与连通分量分析和控制器分配
- **通过反射动态修改控制器浓度，不破坏系统结构** ⭐

## 已解决的问题

### ✅ 1. 粒子不飞出去
**解决**：使用超强冲量（50）+ 高倍增器（15）= 750 m/s 速度

### ✅ 2. 发射时原史莱姆变形
**解决**：使用过渡控制器机制，原史莱姆浓度保持不变

### ✅ 3. 粒子被吸回
**解决**：立即分配到低浓度过渡控制器，脱离原吸引力

### ✅ 4. 粒子不聚集
**解决**：延迟0.5秒后分配到正常浓度的目标控制器

## 疑难解答

**Q: 按鼠标左键没有反应？**
A: 
1. 检查是否有 Slime_PBF 组件
2. 检查地面层设置是否正确
3. 查看 Console 是否有错误信息

**Q: 粒子发射后立刻被吸回来？**
A: 
1. 确保勾选了 `Maintain Original Shape`
2. 检查 `Transition Concentration` 是否设为 0.1
3. 增加 `Impulse Strength` 到 50
4. 增加 `Velocity Multiplier` 到 15

**Q: 原史莱姆变扁了？** ⭐ 新！
A: 
1. **必须勾选 `Maintain Original Shape`**
2. 确保 `Transition Concentration` 设为 0.1（极低）
3. 原史莱姆的 Concentration 保持 10
4. 查看 Console 是否有"创建过渡控制器"的日志

**Q: 粒子发射后不聚集？**
A: 
1. 粒子需要 0.5秒才会开始聚集（延迟分配机制）
2. 等待更长时间让粒子飞到目标
3. 检查目标控制器是否创建成功

**Q: 无法切换控制？**
A: 
1. 等待更多粒子到达目标
2. 降低 `Min Particles For Switch` 参数
3. 按 Tab 键查看当前粒子数

**Q: 发射速度太慢？**
A: 
- 增加 `Impulse Strength` 到 50-100
- 增加 `Velocity Multiplier` 到 15-20
- 增加 `Launch Speed` 到 50-100

## 快速开始指南

### 第一次使用？按照这个顺序设置：

1. **添加组件**：
   ```
   GameObject 
   ├── Slime_PBF ✓
   ├── ControllerTest ✓
   ├── Rigidbody ✓
   └── Collider ✓
   ```

2. **关键参数设置**（⭐ 新推荐）：
   ```
   Slime_PBF:
   └─ Concentration = 10 (保持正常值！)
   
   ControllerTest:
   ├─ Maintain Original Shape = ✓ ⚠️ 必须勾选！
   ├─ Transition Concentration = 0.1
   ├─ Use Impulse Mode = ✓
   ├─ Impulse Strength = 50
   └─ Velocity Multiplier = 15
   ```

3. **测试发射**：
   - 运行游戏
   - 按住鼠标左键瞄准地面
   - 看到粒子飞出去 ✓
   - **原史莱姆保持馒头形状** ✅

4. **切换控制**：
   - 等待粒子落地并聚集
   - 按 Tab 键切换
   - 成功！🎉

## 功能对比

| 功能 | 旧版本 | 新版本 ⭐ |
|-----|--------|----------|
| 粒子发射 | ✓ | ✓ |
| 发射速度 | 中等（15） | 超强（50） |
| 原史莱姆形状 | ❌ 会变扁 | ✅ 保持馒头形 |
| 浓度控制 | 全局降低 | 独立过渡控制器 |
| 粒子归属 | 立即分配 | 延迟分配（0.5s） |
| 形状稳定性 | 不稳定 | 稳定 ⭐ |

## 未来扩展

已实现功能：
- ✅ 冲量模式
- ✅ 速度倍增器
- ✅ 彩色日志输出
- ✅ 形状保持机制 ⭐ 新！
- ✅ 过渡控制器系统 ⭐ 新！
- ✅ 延迟粒子分配 ⭐ 新！

可以考虑添加：
- UI指示器显示目标位置粒子数量
- 不同的发射模式（扇形、连续流等）
- 粒子回收功能（从目标位置发射回原史莱姆）
- 多目标同时控制
- 粒子发射特效和音效
- 可调节的延迟分配时间
- 过渡控制器可视化增强
