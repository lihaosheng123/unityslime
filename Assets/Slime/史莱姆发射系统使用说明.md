# 史莱姆粒子发射与控制系统使用说明

## 功能概述

现在你可以通过鼠标点击将史莱姆粒子发射到指定位置，当目标位置聚集足够的粒子后，可以切换控制到新的史莱姆团块。

## ⚠️ 重要：解决粒子不飞出去的问题

### 问题原因
如果发射时粒子立刻被吸回原地，通常是因为：
1. **Concentration 参数过高** - 在 `Slime_PBF` 组件中，这个值控制粒子向中心聚集的力度
2. **发射速度不够** - 初速度太小无法克服吸引力

### 解决方案
1. **降低 Concentration**：
   - 在 `Slime_PBF` 组件中，将 `concentration` 设为 **5-10** 之间（不要超过15）
   - 原值太高（如30-50）会导致粒子无法分离

2. **使用冲量模式**（推荐）：
   - 在 `ControllerTest` 中勾选 `Use Impulse Mode`
   - 设置 `Impulse Strength = 10-15`
   - 这会给粒子极强的初速度，确保能飞出去

3. **调整发射参数**：
   - `Launch Speed = 15-30`（更快）
   - `Arc Height = 3-5`（更高弧度）
   - `Velocity Multiplier = 3-5`（速度倍增）

## 核心功能

### 1. 粒子发射
- **按住鼠标左键**：向鼠标点击的地面位置发射史莱姆粒子
- 粒子会以抛物线轨迹飞向目标位置
- 发射时会显示：
  - 红色射线：发射方向
  - 黄色弧线：飞行轨迹
  - 青色球体：目标区域
  - 红色小球：发射源位置

### 2. 控制切换
- **按 Tab 键**：切换控制到目标位置的史莱姆
- 只有当目标位置有足够粒子（默认50个）时才能切换
- 切换后你的控制器会移动到新的史莱姆位置

### 3. 基础移动（保留原有功能）
- **WASD/方向键**：移动史莱姆
- **空格键**：跳跃（只在地面时有效）

## 参数说明

### Slime_PBF 核心参数（最重要！）
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| **Concentration** | **5-10** | ⚠️ **关键参数！** 越大粒子越紧密，但过大会导致无法发射 |
| Viscosity Strength | 1-5 | 粘度，影响粒子间的粘连程度 |
| Gravity | -5 到 -10 | 重力，负值向下 |

### ControllerTest 发射设置
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| Shoot Key | Mouse0 | 发射按键（鼠标左键） |
| **Launch Speed** | **15-30** | 发射速度，越大飞得越远 |
| **Arc Height** | **3-5** | 弧线高度，越大弧度越高 |
| Particles Per Batch | 15-20 | 每批发射的粒子数量 |
| Launch Interval | 0.05 | 发射间隔（秒），越小越连续 |
| Min Particles For Switch | 50 | 切换控制需要的最少粒子数 |
| Target Check Radius | 2 | 目标区域半径 |
| Switch Control Key | Tab | 切换控制按键 |
| Show Shoot Debug | true | 是否显示发射调试信息 |

### 发射力度增强（新增！）
| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| **Velocity Multiplier** | **3-5** | 速度倍增器，最终速度 × 这个值 |
| **Use Impulse Mode** | **✓ 勾选** | 使用冲量模式（超强发射） |
| **Impulse Strength** | **10-15** | 冲量模式的力度 |

## 推荐配置组合

### 配置 A：轻松发射（推荐新手）
```
Slime_PBF:
  - Concentration = 5
  - Viscosity Strength = 1

ControllerTest:
  - Use Impulse Mode = ✓
  - Impulse Strength = 15
  - Velocity Multiplier = 5
  - Launch Speed = 20
```

### 配置 B：精确控制
```
Slime_PBF:
  - Concentration = 10
  - Viscosity Strength = 3

ControllerTest:
  - Use Impulse Mode = ✗
  - Launch Speed = 25
  - Arc Height = 4
  - Velocity Multiplier = 4
```

### 配置 C：远距离发射
```
Slime_PBF:
  - Concentration = 8
  - Viscosity Strength = 2

ControllerTest:
  - Use Impulse Mode = ✓
  - Impulse Strength = 20
  - Velocity Multiplier = 5
  - Launch Speed = 30
```

## 使用技巧

1. **分裂策略**：
   - 先移动到墙壁间让史莱姆自然分裂
   - 或者主动发射粒子到目标位置创建新的史莱姆团块

2. **发射技巧**：
   - 持续按住鼠标左键可以连续发射
   - 在发射时可以移动鼠标改变目标位置
   - **注意不要把所有粒子都发射出去**，保留一些在原地
   - 如果粒子不飞出去，立即降低 Concentration 参数

3. **控制切换**：
   - 随时按 Tab 键查看是否可以切换
   - 控制台会用彩色文字显示当前粒子数量
   - 切换后可以在两个史莱姆间来回切换

4. **战术运用**：
   - 将粒子发射到高处或远处探索
   - 在危险区域外创建新的史莱姆团块
   - 通过分裂同时控制多个位置

## 调试工具

### Scene视图调试
当 `Show Shoot Debug` 开启时，会显示：
- **红色射线**：从当前位置指向目标的直线（发射方向）
- **青色线**：连接当前位置和目标的直线
- **绿色线**：目标位置的垂直标记
- **红色小球**：发射源位置（Gizmos）
- **青色球体**：目标区域范围（Gizmos）
- **黄色弧线**：粒子飞行的轨迹预览（Gizmos）

### Console日志（彩色输出）
- 🔵 **青色**：开始发射的消息
- 🟢 **绿色**：成功发射的粒子数量和速度
- 🟡 **黄色**：停止发射和粒子统计
- 🟢 **亮绿**：切换控制成功
- 🟠 **橙色**：粒子数不足警告
- 🔴 **红色**：错误信息

## 技术细节

### 发射机制
1. 从当前位置附近获取一批粒子（优先使用空间查询而非控制器查询）
2. 计算抛物线轨迹或冲量模式的初速度
3. 应用速度倍增器（放大速度）
4. 给粒子施加速度
5. **立即将粒子分配到新控制器**（脱离原控制器吸引）
6. 粒子在 Slime_PBF 的物理系统中飞行并聚集

### 两种发射模式

#### 冲量模式（推荐）
- 直接给粒子一个超强的速度向量
- 方向：指向目标 + 向上分量
- 优点：简单粗暴，确保能飞出去
- 适合：需要强力发射的场景

#### 抛物线模式
- 根据目标距离计算精确的抛物线轨迹
- 优点：轨迹优美，落点准确
- 适合：精确控制和近距离发射

### 控制器管理
- 每次开始发射会在目标位置创建新的粒子控制器
- **粒子立即分配到新控制器，避免被原控制器拉回**
- 控制器会吸引分配给它的粒子聚集
- 当粒子数量足够时，会生成独立的史莱姆实例

### 性能优化
- 使用批量发射避免单次处理太多粒子
- 通过发射间隔控制帧率稳定性
- 空间哈希和网格查询保证粒子检测效率
- 优先使用空间查询而非遍历所有粒子

## 与现有系统的整合

这个功能完全整合到了现有的 PBF 流体模拟系统中：
- 使用 `Slime_PBF` 的公共API进行粒子操作
- 发射的粒子遵循相同的物理约束（碰撞、粘度、重力）
- 自动参与连通分量分析和控制器分配

## 已知限制与解决方案

### 1. 粒子不飞出去 ✅ 已解决
**原因**：Concentration 参数过高
**解决**：降低到 5-10，并使用冲量模式

### 2. 如果当前史莱姆粒子太少
**解决**：降低 `Particles Per Batch`，或等待粒子聚集

### 3. 发射距离过远时不准确
**解决**：增加 `Launch Speed` 和 `Velocity Multiplier`

### 4. 目标区域在空中时粒子散开
**解决**：增加目标控制器的 `Concentration`（需要修改代码）

### 5. 粒子发射后又被吸回
**解决**：
- 确保粒子被立即分配到新控制器（代码已实现）
- 进一步降低原控制器的 Concentration
- 增加 Velocity Multiplier

## 疑难解答

**Q: 按鼠标左键没有反应？**
A: 
1. 检查是否有 Slime_PBF 组件
2. 检查地面层设置是否正确
3. 查看 Console 是否有错误信息

**Q: 粒子发射后立刻被吸回来？** ⚠️ **最常见问题**
A: 
1. **立即降低 Concentration 到 5-10**
2. 勾选 `Use Impulse Mode`
3. 增加 `Impulse Strength` 到 15
4. 增加 `Velocity Multiplier` 到 5

**Q: 粒子发射后不聚集？**
A: 
1. 目标控制器的 Concentration 可能太低
2. 等待更长时间让粒子飞到目标
3. 减少目标距离

**Q: 无法切换控制？**
A: 
1. 等待更多粒子到达目标
2. 降低 `Min Particles For Switch` 参数
3. 按 Tab 键查看当前粒子数

**Q: 发射轨迹不准确？**
A: 
1. 使用冲量模式而非抛物线模式
2. 调整 `Launch Speed` 和 `Arc Height`
3. 检查目标位置是否在地面上

**Q: 粒子发射太慢/太快？**
A: 
- 太慢：增加 `Launch Speed`、`Velocity Multiplier`、`Impulse Strength`
- 太快：降低上述参数，或取消勾选 `Use Impulse Mode`

## 快速开始指南

### 第一次使用？按照这个顺序设置：

1. **添加组件**：
   ```
   GameObject 
   ├── Slime_PBF ✓
   ├── ControllerTest ✓
   ├── Rigidbody ✓
   └── Collider ✓
   ```

2. **关键参数设置**：
   ```
   Slime_PBF.Concentration = 5  ⚠️ 最重要！
   ControllerTest.Use Impulse Mode = ✓
   ControllerTest.Impulse Strength = 15
   ```

3. **测试发射**：
   - 运行游戏
   - 按住鼠标左键瞄准地面
   - 看到粒子飞出去 ✓

4. **切换控制**：
   - 等待粒子落地
   - 按 Tab 键切换
   - 成功！🎉

## 未来扩展

可以考虑添加：
- ✅ 冲量模式（已实现）
- ✅ 速度倍增器（已实现）
- ✅ 彩色日志输出（已实现）
- UI指示器显示目标位置粒子数量
- 不同的发射模式（扇形、连续流等）
- 粒子回收功能（从目标位置发射回原史莱姆）
- 多目标同时控制
- 粒子发射特效和音效
- 发射时临时降低原控制器浓度（自动化）
